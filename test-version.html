<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group 1: Similar Letters (А К М О Т Е)</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .back-button {
            margin-bottom: 20px;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header {
            margin-bottom: 30px;
        }

        .group-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .module-info {
            color: #6c757d;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
        }

        .progress-text {
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .word-display {
            margin: 40px 0;
        }

        .current-word {
            font-size: 4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            min-height: 4.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .word-image {
            max-width: 200px;
            height: 200px;
            object-fit: contain;
            margin: 20px auto;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: block;
        }

        .word-meaning {
            color: #6c757d;
            font-size: 1.1rem;
            font-style: italic;
            margin-top: 10px;
        }

        .controls {
            margin: 40px 0;
        }

        .main-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover {
            background: #5a6fd8;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:active {
            transform: translateY(-1px);
        }

        .control-btn:disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .listen-btn {
            background: #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .listen-btn:hover {
            background: #218838;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }

        .next-btn {
            background: #fd7e14;
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
        }

        .next-btn:hover {
            background: #e8690b;
            box-shadow: 0 8px 25px rgba(253, 126, 20, 0.4);
        }

        .mic-btn {
            background: #e74c3c;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .mic-btn:hover {
            background: #c0392b;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .mic-btn.listening {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .exercise-selector {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .exercise-selector h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .exercise-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .exercise-btn {
            background: white;
            border: 2px solid #2196f3;
            color: #2196f3;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .exercise-btn:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .exercise-btn.active {
            background: #2196f3;
            color: white;
        }

        .unlock-message {
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .dictation-input {
            background: white;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2rem;
            text-align: center;
            margin: 20px 0;
            min-width: 200px;
        }

        .dictation-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .check-answer-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            margin: 10px;
            transition: all 0.3s ease;
        }

        .check-answer-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .pronunciation-score {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .score-circle {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 4px solid white;
            border-radius: 50%;
            line-height: 52px;
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px;
        }

        .recognition-question {
            text-align: center;
            margin: 20px 0;
        }

        .recognition-question h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .word-choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .choice-btn {
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            color: #495057;
            padding: 20px 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .choice-btn:hover {
            border-color: #667eea;
            background: #e3f2fd;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .choice-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .choice-btn.correct {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .choice-btn.incorrect {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .feedback {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .feedback.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .keyboard-hint {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 15px;
        }

        .stats-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .completion-message {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
        }

        .completion-message h2 {
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .completion-message p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        /* Loading animation */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .audio-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
                padding: 20px;
            }

            .current-word {
                font-size: 3rem;
            }

            .main-controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 280px;
                margin: 5px 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="back-button">
        <button class="back-btn" onclick="window.location.href='../index.html'">← Back to Menu</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="group-title">Similar Letters</h1>
            <p class="module-info" id="moduleInfo">Module 1: М, А</p>
        </div>

        <div class="progress-container">
            <div class="progress-text" id="progressText">Word 1 of 1</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="word-display">
            <div class="current-word" id="currentWord">МАМА</div>
            <img class="word-image hidden" id="wordImage" alt="Word illustration">
            <div class="word-meaning hidden" id="wordMeaning"></div>
        </div>

        <div class="controls">
            <div class="main-controls">
                <button class="control-btn listen-btn" id="listenBtn" onclick="playCurrentWord()">
                    🔊 Listen
                </button>
                <button class="control-btn mic-btn" id="micBtn" onclick="startRecording()" disabled>
                    🎤 Say It
                </button>
                <button class="control-btn next-btn" id="nextBtn" onclick="nextWord()">
                    Next Word →
                </button>
            </div>
            
            <!-- Exercise Type Selector -->
            <div class="exercise-selector" id="exerciseSelector">
                <h4>Choose Exercise Type:</h4>
                <div class="exercise-buttons">
                    <button class="exercise-btn active" onclick="setExerciseType('pronunciation')">🔊 Pronunciation</button>
                    <button class="exercise-btn hidden" id="dictationBtn" onclick="setExerciseType('dictation')">✍️ Dictation</button>
                    <button class="exercise-btn hidden" id="recognitionBtn" onclick="setExerciseType('recognition')">🎯 Sound Recognition</button>
                </div>
                <p class="unlock-message hidden" id="unlockMessage">Complete all 6 modules to unlock Dictation and Sound Recognition!</p>
            </div>

            <!-- Dictation Input -->
            <div class="hidden" id="dictationArea">
                <input type="text" class="dictation-input" id="dictationInput" placeholder="Type what you hear..." maxlength="20">
                <button class="check-answer-btn" onclick="checkDictation()">Check Answer</button>
            </div>

            <!-- Sound Recognition Area -->
            <div class="hidden" id="recognitionArea">
                <div class="recognition-question">
                    <h4>Which word do you hear?</h4>
                    <div class="word-choices">
                        <button class="choice-btn" id="choice1" onclick="selectChoice(0)">CHOICE 1</button>
                        <button class="choice-btn" id="choice2" onclick="selectChoice(1)">CHOICE 2</button>
                    </div>
                </div>
            </div>

            <!-- Pronunciation Score -->
            <div class="pronunciation-score hidden" id="pronunciationScore">
                <div>Pronunciation Accuracy</div>
                <div class="score-circle" id="scoreCircle">--%</div>
                <div id="scoreMessage">Click Say It to try!</div>
            </div>

            <div class="keyboard-hint">
                Press Space to listen, Enter for next word
            </div>
        </div>

        <div class="stats-container">
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="currentModuleNum">1</span>
                    <div class="stat-label">Module</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="wordsCompleted">0</span>
                    <div class="stat-label">Words Learned</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="totalProgress">0%</span>
                    <div class="stat-label">Total Progress</div>
                </div>
            </div>
        </div>

        <div class="completion-message hidden" id="completionMessage">
            <h2>Module Complete!</h2>
            <p>Great job! You've learned all the words in this module.</p>
            <p>Ready to move to the next module?</p>
        </div>
    </div>

    <script>
        // Simplified data structure
        const modules = {
            1: {
                name: "М, А",
                words: [
                    { word: "МАМА", meaning: "mama", image: "mama.jpg.png" }
                ]
            },
            2: {
                name: "+ К", 
                words: [
                    { word: "МАК", meaning: "poppy", image: "mac.jpg.png" },
                    { word: "МАКАКА", meaning: "macaque", image: "monkey.jpg.png" }
                ]
            },
            3: {
                name: "+ О",
                words: [
                    { word: "КОМА", meaning: "coma" },
                    { word: "КАКАО", meaning: "cacao", image: "cacao.jpg.png" },
                    { word: "МОККО", meaning: "mocha" }
                ]
            },
            4: {
                name: "+ Т",
                words: [
                    { word: "КОТ", meaning: "cat", image: "cat.jpg.png" },
                    { word: "ТОМ", meaning: "Tom", image: "tom-cat.jpg.png" },
                    { word: "АТОМ", meaning: "atom", image: "atom.jpg.png" },
                    { word: "ТОМАТ", meaning: "tomato", image: "tomat.jpg.png" },
                    { word: "АТАКА", meaning: "attack" },
                    { word: "АКТ", meaning: "act" },
                    { word: "ТАКТ", meaning: "tact" },
                    { word: "МОТО", meaning: "moto" }
                ]
            },
            5: {
                name: "+ Е",
                words: [
                    { word: "МЕТА", meaning: "meta" },
                    { word: "ТЕМА", meaning: "theme" },
                    { word: "МЕМ", meaning: "meme" },
                    { word: "МЕККА", meaning: "Mecca" },
                    { word: "МАКЕТ", meaning: "maquette" },
                    { word: "КОМЕТА", meaning: "comet", image: "comet.jpg.png" }
                ]
            },
            6: {
                name: "Stress Rules",
                words: [
                    { word: "МА́МА", meaning: "mama (stressed)" },
                    { word: "МЕ́ТА", meaning: "meta (stressed)" },
                    { word: "ТЕ́МА", meaning: "theme (stressed)" },
                    { word: "МЕ́ККА", meaning: "Mecca (stressed)" },
                    { word: "МАКЕ́Т", meaning: "maquette (stressed)" },
                    { word: "МАКА́КА", meaning: "monkey (stressed)" },
                    { word: "АТА́КА", meaning: "attack (stressed)" },
                    { word: "КОТ", meaning: "cat" },
                    { word: "ТОМ", meaning: "Tom" },
                    { word: "АКТ", meaning: "act" },
                    { word: "ТАКТ", meaning: "tact" },
                    { word: "ТОМА́Т", meaning: "tomato (stressed)" },
                    { word: "А́ТОМ", meaning: "atom (stressed)" },
                    { word: "КО́МА", meaning: "coma (stressed)" },
                    { word: "МО́ТО", meaning: "moto (stressed)" },
                    { word: "МО́ККО", meaning: "mocha (stressed)" }
                ]
            }
        };

        // Global state
        let currentModule = 1;
        let currentWordIndex = 0;
        let totalWordsCompleted = 0;
        let currentAudio = null;
        let exerciseType = 'pronunciation';
        let allModulesCompleted = false;
        let recognition = null;
        let isListening = false;
        
        // Sound Recognition variables
        let currentChoices = [];
        let correctChoice = 0;
        let selectedChoice = -1;
        
        // Statistics and Gamification
        let stats = {
            wordsPracticed: 0,
            totalScore: 0,
            scores: [],
            currentStreak: 0,
            bestStreak: 0,
            exp: 0,
            level: 1
        };

        // Base URLs
        const imageBaseUrl = 'https://raw.githubusercontent.com/kariwari13/russianpractice/main/images/';
        const audioBaseUrl = 'https://raw.githubusercontent.com/kariwari13/russianpractice/main/audio/';

        // Sound pairs for recognition exercises
        const soundPairs = [
            ['МАК', 'МАКАКА'], ['КОТ', 'ТОМ'], ['АТОМ', 'ТОМАТ'], ['АКТ', 'ТАКТ'],
            ['МЕТА', 'ТЕМА'], ['МЕМ', 'МЕККА'], ['МАКЕТ', 'КОМЕТА'], ['КОМА', 'КАКАО'],
            ['МА́МА', 'МАКА́КА'], ['МЕ́ТА', 'ТЕ́МА'], ['КО́МА', 'ТОМА́Т'], ['А́ТОМ', 'АТА́КА']
        ];

        // Initialize
        function init() {
            initSpeechRecognition();
            updateDisplay();
            
            // Show unlock message initially
            document.getElementById('unlockMessage').classList.remove('hidden');
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space') {
                    e.preventDefault();
                    playCurrentWord();
                } else if (e.code === 'Enter') {
                    e.preventDefault();
                    nextWord();
                }
            });
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ru-RU';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => {
                    isListening = true;
                    const micBtn = document.getElementById('micBtn');
                    micBtn.classList.add('listening');
                    micBtn.textContent = '🎤 Listening...';
                    showFeedback('Speak now...', 'info');
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    
                    if (exerciseType === 'pronunciation') {
                        const moduleData = modules[currentModule];
                        const currentWord = moduleData.words[currentWordIndex].word;
                        const score = calculatePronunciationScore(transcript, currentWord);
                        showPronunciationScore(score, transcript, currentWord);
                        showFeedback(`You said: "${transcript}"`, score >= 70 ? 'success' : 'error');
                    }
                };

                recognition.onerror = (event) => {
                    showFeedback('Could not recognize speech. Try again.', 'error');
                    stopListening();
                };

                recognition.onend = () => {
                    stopListening();
                };
            }
        }

        function startRecording() {
            if (!recognition) {
                showFeedback('Speech recognition not available', 'error');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            try {
                recognition.abort();
                setTimeout(() => {
                    recognition.start();
                }, 100);
            } catch (error) {
                showFeedback('Could not start recording', 'error');
            }
        }

        function stopListening() {
            isListening = false;
            const micBtn = document.getElementById('micBtn');
            micBtn.classList.remove('listening');
            micBtn.textContent = '🎤 Say It';
            
            setTimeout(() => {
                micBtn.disabled = false;
            }, 500);
            
            hideFeedback();
        }

        function setExerciseType(type) {
            if ((type === 'dictation' || type === 'recognition') && !allModulesCompleted) {
                showFeedback('Complete all 6 modules first to unlock this exercise!', 'error');
                return;
            }
            
            exerciseType = type;
            
            document.querySelectorAll('.exercise-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateExerciseDisplay();
        }

        function updateExerciseDisplay() {
            const dictationArea = document.getElementById('dictationArea');
            const pronunciationScore = document.getElementById('pronunciationScore');
            const recognitionArea = document.getElementById('recognitionArea');
            
            dictationArea.classList.add('hidden');
            pronunciationScore.classList.add('hidden');
            recognitionArea.classList.add('hidden');
            
            if (exerciseType === 'pronunciation') {
                pronunciationScore.classList.remove('hidden');
            } else if (exerciseType === 'dictation' && allModulesCompleted) {
                dictationArea.classList.remove('hidden');
                document.getElementById('currentWord').textContent = '?';
            } else if (exerciseType === 'recognition' && allModulesCompleted) {
                recognitionArea.classList.remove('hidden');
                setupSoundRecognition();
            }
        }

        function setupSoundRecognition() {
            // Implementation for sound recognition
            const availablePairs = soundPairs.filter(pair => {
                // Filter based on learned words
                return true; // Simplified for now
            });
            
            if (availablePairs.length > 0) {
                const randomPair = availablePairs[Math.floor(Math.random() * availablePairs.length)];
                currentChoices = [...randomPair];
                correctChoice = Math.floor(Math.random() * 2);
                
                document.getElementById('choice1').textContent = currentChoices[0];
                document.getElementById('choice2').textContent = currentChoices[1];
                
                setTimeout(() => {
                    const wordToPlay = currentChoices[correctChoice];
                    playTextToSpeech(wordToPlay);
                }, 1000);
            }
        }

        function selectChoice(choiceIndex) {
            selectedChoice = choiceIndex;
            
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            if (choiceIndex === 0) {
                document.getElementById('choice1').classList.add('selected');
            } else {
                document.getElementById('choice2').classList.add('selected');
            }
            
            setTimeout(() => {
                checkSoundRecognition();
            }, 500);
        }

        function checkSoundRecognition() {
            const isCorrect = selectedChoice === correctChoice;
            
            if (correctChoice === 0) {
                document.getElementById('choice1').classList.add('correct');
                if (selectedChoice === 1) {
                    document.getElementById('choice2').classList.add('incorrect');
                }
            } else {
                document.getElementById('choice2').classList.add('correct');
                if (selectedChoice === 0) {
                    document.getElementById('choice1').classList.add('incorrect');
                }
            }
            
            showFeedback(isCorrect ? 'Correct! Well done! 🎉' : 'Not quite right. Try again!', 
                         isCorrect ? 'success' : 'error');
        }

        function checkDictation() {
            const userInput = document.getElementById('dictationInput').value.trim().toUpperCase();
            const correctWord = window.currentDictationWord || 'МАМА';
            const correctWordClean = correctWord.replace(/́/g, '');
            
            if (userInput === correctWordClean) {
                showFeedback(`Correct! The word was: ${correctWord}`, 'success');
                stats.currentStreak++;
            } else {
                showFeedback(`Try again! You wrote: "${userInput}"`, 'error');
                stats.currentStreak = 0;
            }
            
            stats.wordsPracticed++;
        }

        function calculatePronunciationScore(spoken, target) {
            const spokenClean = spoken.toLowerCase().replace(/[^\u0400-\u04FF\s]/g, '');
            const targetClean = target.toLowerCase().replace(/[^\u0400-\u04FF\s]/g, '');
            
            if (spokenClean === targetClean) return 100;
            
            // Simple similarity calculation
            const maxLen = Math.max(spokenClean.length, targetClean.length);
            if (maxLen === 0) return 100;
            
            let matches = 0;
            for (let i = 0; i < Math.min(spokenClean.length, targetClean.length); i++) {
                if (spokenClean[i] === targetClean[i]) matches++;
            }
            
            return Math.round((matches / maxLen) * 100);
        }

        function showPronunciationScore(score) {
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreMessage = document.getElementById('scoreMessage');
            
            scoreCircle.textContent = score + '%';
            
            if (score >= 90) {
                scoreMessage.textContent = 'Perfect! 🌟';
                scoreCircle.style.borderColor = '#28a745';
            } else if (score >= 70) {
                scoreMessage.textContent = 'Good job! 👍';
                scoreCircle.style.borderColor = '#ffc107';
            } else {
                scoreMessage.textContent = 'Keep trying! 💪';
                scoreCircle.style.borderColor = '#fd7e14';
            }
            
            stats.scores.push(score);
            stats.wordsPracticed++;
            stats.totalScore += score;
            
            if (score >= 70) {
                stats.currentStreak++;
            } else {
                stats.currentStreak = 0;
            }
        }

        function showFeedback(message, type) {
            // Create feedback element if it doesn't exist
            let feedback = document.getElementById('feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.id = 'feedback';
                feedback.className = 'feedback hidden';
                document.querySelector('.controls').appendChild(feedback);
            }
            
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
            feedback.classList.remove('hidden');
            
            setTimeout(() => {
                feedback.classList.add('hidden');
            }, 3000);
        }

        function hideFeedback() {
            const feedback = document.getElementById('feedback');
            if (feedback) {
                feedback.classList.add('hidden');
            }
        }

        function updateDisplay() {
            const moduleData = modules[currentModule];
            const currentWordData = moduleData.words[currentWordIndex];
            
            // Update module info
            document.getElementById('moduleInfo').textContent = `Module ${currentModule}: ${moduleData.name}`;
            document.getElementById('currentModuleNum').textContent = currentModule;
            
            // Update progress
            const progressText = `Word ${currentWordIndex + 1} of ${moduleData.words.length}`;
            document.getElementById('progressText').textContent = progressText;
            
            const progressPercent = ((currentWordIndex + 1) / moduleData.words.length) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';
            
            // Update word display
            document.getElementById('currentWord').textContent = currentWordData.word;
            
            // Update image
            const wordImage = document.getElementById('wordImage');
            const wordMeaning = document.getElementById('wordMeaning');
            
            if (currentWordData.image) {
                wordImage.src = imageBaseUrl + currentWordData.image;
                wordImage.classList.remove('hidden');
                wordImage.onerror = () => wordImage.classList.add('hidden');
            } else {
                wordImage.classList.add('hidden');
            }
            
            // Show meaning
            if (currentWordData.meaning) {
                wordMeaning.textContent = `(${currentWordData.meaning})`;
                wordMeaning.classList.remove('hidden');
            } else {
                wordMeaning.classList.add('hidden');
            }
            
            // Update stats
            document.getElementById('wordsCompleted').textContent = totalWordsCompleted;
            
            // Calculate total progress across all modules
            let totalWords = 0;
            for (let i = 1; i <= 6; i++) {
                totalWords += modules[i].words.length;
            }
            const totalProgressPercent = Math.round((totalWordsCompleted / totalWords) * 100);
            document.getElementById('totalProgress').textContent = totalProgressPercent + '%';
            
            // Auto-play audio
            setTimeout(() => {
                playCurrentWord();
            }, 500);
        }

        async function playCurrentWord() {
            const moduleData = modules[currentModule];
            const currentWordData = moduleData.words[currentWordIndex];
            const word = currentWordData.word;
            
            // Show loading state
            const listenBtn = document.getElementById('listenBtn');
            const originalText = listenBtn.innerHTML;
            listenBtn.innerHTML = '🔊 Playing <span class="audio-loading"></span>';
            listenBtn.disabled = true;
            
            try {
                await playTextToSpeech(word);
            } catch (error) {
                console.error('Audio playback failed:', error);
            } finally {
                listenBtn.innerHTML = originalText;
                listenBtn.disabled = false;
            }
        }

        async function playTextToSpeech(text) {
            const cleanText = text.replace(/́/g, '').toLowerCase();
            const audioUrl = `${audioBaseUrl}${cleanText}.mp3`;
            
            return new Promise((resolve, reject) => {
                if (currentAudio) {
                    currentAudio.pause();
                }
                
                currentAudio = new Audio(audioUrl);
                
                currentAudio.onended = () => {
                    resolve();
                };
                
                currentAudio.onerror = () => {
                    // Fallback to Web Speech API
                    playWebSpeechTTS(text).then(resolve).catch(reject);
                };
                
                currentAudio.play().catch(() => {
                    playWebSpeechTTS(text).then(resolve).catch(reject);
                });
            });
        }

        async function playWebSpeechTTS(text) {
            return new Promise((resolve, reject) => {
                if (!('speechSynthesis' in window)) {
                    reject(new Error('Speech synthesis not supported'));
                    return;
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ru-RU';
                utterance.rate = 0.8;
                
                utterance.onend = resolve;
                utterance.onerror = reject;
                
                speechSynthesis.speak(utterance);
            });
        }

        function nextWord() {
            const moduleData = modules[currentModule];
            
            // Mark current word as completed
            totalWordsCompleted++;
            
            currentWordIndex++;
            
            if (currentWordIndex >= moduleData.words.length) {
                // Module complete
                if (currentModule < 6) {
                    showModuleComplete();
                    setTimeout(() => {
                        nextModule();
                    }, 2000);
                } else {
                    showFinalComplete();
                }
            } else {
                // Next word in current module
                updateDisplay();
            }
        }

        function nextModule() {
            currentModule++;
            currentWordIndex = 0;
            document.getElementById('completionMessage').classList.add('hidden');
            updateDisplay();
        }

        function showModuleComplete() {
            const message = document.getElementById('completionMessage');
            message.classList.remove('hidden');
            
            if (currentModule === 5) {
                message.innerHTML = `
                    <h2>🌟 Like a COMET, you've mastered this group!</h2>
                    <p>You've learned all letters: А К М О Т Е</p>
                    <p>Moving to Stress Rules...</p>
                `;
            } else {
                message.innerHTML = `
                    <h2>Module ${currentModule} Complete!</h2>
                    <p>Great job! Moving to the next module...</p>
                `;
            }
        }

        function showFinalComplete() {
            const message = document.getElementById('completionMessage');
            message.innerHTML = `
                <h2>🎉 All Modules Complete!</h2>
                <p>Congratulations! You've mastered the first letter group!</p>
                <p>Ready for Group 2: False Friends?</p>
            `;
            message.classList.remove('hidden');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
